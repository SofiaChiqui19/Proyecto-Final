<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registrar Empresa</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #ecf0f1;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
    }
    .wrap {
      width: min(640px, 94vw);
      background: #fff;
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 10px 25px rgba(0,0,0,.06);
    }
    h1 { margin: 8px 0 16px; color:#2c3e50; text-align:center; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    .grid > .full { grid-column: 1 / -1; }
    label { display:block; font-size: 13px; color:#34495e; margin-bottom:6px; }
    input {
      width: 100%; padding: 10px 12px; border:1px solid #dfe6e9; border-radius:8px;
      font-size: 15px; outline: none; background:#fbfbfb;
    }
    input:focus { border-color:#1abc9c; background:#fff; }
    .hint { color:#7f8c8d; font-size:12px; margin-top:6px; }
    .actions { display:flex; gap:10px; margin-top:14px; }
    button {
      flex:1;
      background:#1abc9c; border:none; color:#fff; padding:12px;
      border-radius:10px; cursor:pointer; font-weight:600; font-size:15px;
    }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .ghost { background:#ecf0f1; color:#2c3e50; }
    .msg { margin-top:12px; font-size:14px; }
    .msg.err { color:#c0392b; }
    .msg.ok  { color:#27ae60; }
    .topnav { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .topnav a { color:#1abc9c; text-decoration:none; font-size:14px; }
    .logo { text-align:center; margin-bottom:10px; }
    .logo img { max-width:140px; }
    .preview { display:flex; align-items:center; gap:12px; }
    .preview img { width:72px; height:72px; object-fit:cover; border-radius:10px; border:1px solid #eee; }
    @media (max-width:640px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topnav">
      <a href="/">← Volver al inicio</a>
      <a href="/login.html">¿Ya tienes cuenta? Inicia sesión</a>
    </div>

    <div class="logo">
      <img src="/img/logo.png" alt="Logo" />
    </div>

    <h1>Registrar Empresa</h1>

    <!-- IMPORTANTE: multipart/form-data -->
    <form id="companyForm" enctype="multipart/form-data" autocomplete="on" novalidate>
      <div class="grid">
        <div class="full">
          <label for="repName">Nombre del representante</label>
          <input id="repName" name="name" type="text" placeholder="Ej: Ana Pérez" required />
        </div>

        <div>
          <label for="email">Correo de acceso</label>
          <input id="email" name="email" type="email" placeholder="empresa@correo.com" required />
          <div class="hint">Este correo será el usuario para iniciar sesión.</div>
        </div>

        <div>
          <label for="password">Contraseña</label>
          <input id="password" name="password" type="password" placeholder="Mínimo 6 caracteres" minlength="6" required />
        </div>

        <div class="full"><hr /></div>

        <div class="full">
          <label for="companyName">Nombre de la empresa</label>
          <input id="companyName" name="company_name" type="text" placeholder="Mi Empresa SAS" required />
        </div>

        <div>
          <label for="nit">NIT</label>
          <input id="nit" name="company_nit" type="text" placeholder="900123456-7" />
        </div>

        <div>
          <label for="website">Sitio web</label>
          <input id="website" name="company_website" type="url" placeholder="https://miempresa.co" />
        </div>

        <div class="full">
          <label for="location">Ubicación</label>
          <input id="location" name="company_location" type="text" placeholder="Villavicencio" />
        </div>

        <div class="full">
          <label>Logo de la empresa (PNG/JPG/WEBP/GIF, máx 2MB)</label>
          <div class="preview">
            <input id="logo" name="logo" type="file" accept="image/*" />
            <img id="logoPreview" alt="Vista previa" style="display:none;">
          </div>
          <div class="hint">Este logo aparecerá en las ofertas.</div>
        </div>

        <div class="full actions">
          <button type="submit" id="submitBtn">Crear cuenta de empresa</button>
          <button type="button" class="ghost" id="cancelBtn">Cancelar</button>
        </div>
      </div>

      <div id="msg" class="msg" aria-live="polite"></div>
    </form>
  </div>

  <script>
    const form = document.getElementById('companyForm');
    const btn  = document.getElementById('submitBtn');
    const msg  = document.getElementById('msg');
    const cancelBtn = document.getElementById('cancelBtn');

    // Preview de logo
    const fileInput = document.getElementById('logo');
    const preview   = document.getElementById('logoPreview');
    fileInput.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if (f) {
        const url = URL.createObjectURL(f);
        preview.src = url;
        preview.style.display = 'block';
      } else {
        preview.src = '';
        preview.style.display = 'none';
      }
    });

    cancelBtn.onclick = () => history.back();

    function setMsg(text, ok=false){
      msg.textContent = text || '';
      msg.className = 'msg ' + (ok ? 'ok' : 'err');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMsg('');
      btn.disabled = true;

      // Validaciones rápidas
      const repName = document.getElementById('repName').value.trim();
      const email   = document.getElementById('email').value.trim();
      const pass    = document.getElementById('password').value;
      const companyName = document.getElementById('companyName').value.trim();
      if (!repName || !email || !pass || !companyName) {
        setMsg('Completa los campos obligatorios.', false);
        btn.disabled = false;
        return;
      }
      if (pass.length < 6) {
        setMsg('La contraseña debe tener al menos 6 caracteres.', false);
        btn.disabled = false;
        return;
      }

      // Enviar todo con FormData (incluye archivo si se seleccionó)
      const fd = new FormData(form);

      try {
        const res = await fetch('/api/auth/register-company', { method: 'POST', body: fd });
        const json = await res.json();

        if (!res.ok) {
          setMsg(json.error || json.detail || 'No se pudo registrar la empresa.', false);
        } else {
          setMsg('Empresa registrada correctamente. Redirigiendo…', true);

          try {
            localStorage.setItem('user', JSON.stringify({
              id: json.userId ?? null,
              name: repName,
              role: 'EMPLOYER'
            }));
          } catch {}

          setTimeout(() => {
            const params = new URLSearchParams(location.search);
            const next = params.get('next') || '/dashboard.html';
            location.href = next;
          }, 700);
        }
      } catch (err) {
        console.error(err);
        setMsg('No se pudo conectar con el servidor.', false);
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
