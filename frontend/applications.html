<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Postulaciones - Portal de Empleos</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    body { background:#f5f7fb; font-family: system-ui, Arial, sans-serif; margin:0; }
    header { background:#1abc9c; color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    header a { color:#fff; text-decoration:none; font-weight:600; }
    .h-actions a, .h-actions button { color:#fff; text-decoration:none; font-weight:600; background:transparent; border:none; cursor:pointer; }
    .divider { opacity:.6; margin:0 8px; }
    main { max-width:980px; margin:28px auto; padding:0 16px; }
    h1 { margin:0; font-size:20px; }
    .btn { background:#1abc9c; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600; }
    .btn.ghost { background:#ecf0f1; color:#2c3e50; }
    .list { margin: 18px 0 40px; }
    .card { background:#fff; border:1px solid #eaeaea; border-radius:12px; box-shadow:0 8px 22px rgba(0,0,0,.05); padding:16px; margin:12px 0; }
    .row { display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; }
    .meta { color:#6c7a89; font-size:13px; }
    .pill { font-size:12px; padding:4px 10px; border-radius:999px; font-weight:700; letter-spacing:.2px; display:inline-block; }
    .st-applied   { background:#dfe6e9; color:#2c3e50; }
    .st-reviewing { background:#f6d6a6; color:#8a5a00; }
    .st-hired     { background:#bdebd1; color:#0c6d2d; }
    .st-rejected  { background:#f5b7b1; color:#7b241c; }
    .salary { font-weight:600; }
    .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .danger { background:#e74c3c; color:#fff; }
    .muted { color:#7f8c8d; }
    footer { text-align:center; margin-top:50px; padding:10px; background:#34495e; color:#fff; }
    .empty { color:#7f8c8d; background:#fff; border:1px dashed #cfd8dc; border-radius:10px; padding:16px; text-align:center; }
  </style>
</head>
<body>
  <header>
    <h1>Mis Postulaciones</h1>
    <div class="h-actions" id="navActions">
      <a href="/">üè† Inicio</a>
      <span class="divider">|</span>
      <!-- se rellenan links seg√∫n rol -->
    </div>
  </header>

  <main>
    <section id="appsList" class="list">
      <p class="muted">Cargando tus postulaciones...</p>
    </section>
  </main>

  <footer>
    <small>¬© Portal Empleos - Corredor Ecol√≥gico 2025</small>
  </footer>

  <script>
    const state = { user: null };

    const fmtMoney = (n) => {
      if (n == null || n === '' || isNaN(Number(n))) return '‚Äî';
      return new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 }).format(Number(n));
    };
    const fmtDate = (d) => new Date(d).toLocaleString();

    function badge(status){
      const s = (status || 'APPLIED').toUpperCase();
      if (s === 'REVIEWING') return '<span class="pill st-reviewing">REVIEWING</span>';
      if (s === 'HIRED')     return '<span class="pill st-hired">HIRED</span>';
      if (s === 'REJECTED')  return '<span class="pill st-rejected">REJECTED</span>';
      return '<span class="pill st-applied">APPLIED</span>';
    }
    function cancellable(status){
      const s = (status || 'APPLIED').toUpperCase();
      return s === 'APPLIED' || s === 'REVIEWING';
    }

    function renderHeaderLinks(user){
      const nav = document.getElementById('navActions');
      if (!nav) return;

      // Limpia lo que hubiera despu√©s del "Inicio |"
      nav.querySelectorAll('a[data-dyn], button[data-dyn], span[data-dyn]').forEach(n => n.remove());

      if (!user){
        const a = document.createElement('a');
        a.href = '/login.html?next=/applications.html';
        a.textContent = 'Iniciar sesi√≥n';
        a.setAttribute('data-dyn','');
        nav.appendChild(a);
        return;
      }

      const isUser = user.role === 'USER';
      const profileHref = isUser ? '/profile.html' : '/company-profile.html';
      const profileText = isUser ? 'Mi perfil' : 'Perfil empresa';
      const auxHref = isUser ? '/applications.html' : '/dashboard.html';
      const auxText = isUser ? 'Mis postulaciones' : 'Dashboard empresa';

      const div = document.createElement('span');
      div.setAttribute('data-dyn','');
      div.innerHTML = `
        <span class="divider" data-dyn>|</span>
        <a href="${profileHref}" data-dyn>${profileText}</a>
        <span class="divider" data-dyn>|</span>
        <a href="${auxHref}" data-dyn>${auxText}</a>
        <span class="divider" data-dyn>|</span>
        <button id="logoutBtn" data-dyn>Cerrar sesi√≥n</button>
      `;
      nav.appendChild(div);

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn){
        logoutBtn.onclick = async () => {
          try { await fetch('/api/auth/logout', { method:'POST' }); } catch {}
          localStorage.removeItem('user');
          location.href = '/';
        };
      }
    }

    async function fetchSession() {
      try {
        const r = await fetch('/api/auth/me');
        const data = await r.json();
        state.user = data.user || null;

        // Solo USERS pueden ver esta p√°gina
        if (!state.user) {
          alert('Debes iniciar sesi√≥n para ver tus postulaciones.');
          location.href = '/login.html?next=/applications.html';
          return;
        }
        if (state.user.role !== 'USER'){
          alert('Esta p√°gina es solo para usuarios postulantes.');
          location.href = '/dashboard.html';
          return;
        }

        renderHeaderLinks(state.user);
        loadApplications();
      } catch (e) {
        console.error(e);
        document.getElementById('appsList').innerHTML = '<p class="empty">No pudimos verificar tu sesi√≥n.</p>';
      }
    }

    async function loadApplications() {
      const list = document.getElementById('appsList');
      try {
        const r = await fetch('/api/applications/mine');
        const data = await r.json();

        const apps = data.applications || data;
        if (!Array.isArray(apps) || !apps.length) {
          list.innerHTML = '<div class="empty">No tienes postulaciones a√∫n. <br/>Visita la p√°gina de inicio para postularte a un empleo.</div>';
          return;
        }

        list.innerHTML = apps.map(appCard).join('');
        bindCancelButtons();
      } catch (e) {
        console.error('loadApplications error:', e);
        list.innerHTML = '<p class="empty">Error cargando tus postulaciones.</p>';
      }
    }

    function appCard(a) {
      const canCancel = cancellable(a.status);
      return `
        <article class="card">
          <div class="row">
            <div>
              <h3 style="margin:0 0 6px">${a.title}</h3>
              <div class="meta">Empresa: <b>${a.company}</b> ¬∑ Ubicaci√≥n: ${a.location || '‚Äî'}</div>
              <div class="meta">Salario: <span class="salary">${fmtMoney(a.salary)}</span></div>
              <div class="meta">Postulado: ${fmtDate(a.created_at)}</div>
            </div>
            <div class="actions">
              <div>Estado: ${badge(a.status)}</div>
              ${canCancel ? `<button class="btn danger cancel-btn" data-id="${a.application_id}">‚ùå Cancelar</button>` : ''}
            </div>
          </div>
        </article>
      `;
    }

    function bindCancelButtons() {
      document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          if (!confirm('¬øDeseas cancelar esta postulaci√≥n?')) return;
          try {
            const r = await fetch(`/api/applications/${id}`, { method: 'DELETE' });
            const j = await r.json().catch(()=>({}));
            if (r.ok) {
              await loadApplications();
            } else {
              alert(j.error || j.msg || 'Error al eliminar.');
            }
          } catch (e) {
            console.error(e);
            alert('Error de red al eliminar.');
          }
        });
      });
    }

    fetchSession();
  </script>
</body>
</html>
